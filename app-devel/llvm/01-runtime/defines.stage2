PKGNAME=llvm-runtime
PKGSEC=libs
PKGDEP="gcc-runtime libedit libffi ncurses zlib"
BUILDDEP=""
BUILDDEP__RETRO=""
BUILDDEP__ARMV4="${BUILDDEP__RETRO}"
BUILDDEP__ARMV6HF="${BUILDDEP__RETRO}"
BUILDDEP__ARMV7HF="${BUILDDEP__RETRO}"
BUILDDEP__I486="${BUILDDEP__RETRO}"
BUILDDEP__LOONGSON2F="${BUILDDEP__RETRO}"
BUILDDEP__POWERPC="${BUILDDEP__RETRO}"
BUILDDEP__PPC64="${BUILDDEP__RETRO}"
PKGDES="Low Level Virtual Machine Infrastructure (runtime libraries)"

AB_FLAGS_O3=1
AB_FLAGS_O3__RETRO=0
AB_FLAGS_O3__ARMV4="${AB_FLAGS_O3__RETRO}"
AB_FLAGS_O3__ARMV6HF="${AB_FLAGS_O3__RETRO}"
AB_FLAGS_O3__ARMV7HF="${AB_FLAGS_O3__RETRO}"
AB_FLAGS_O3__I486="${AB_FLAGS_O3__RETRO}"
AB_FLAGS_O3__LOONGSON2F="${AB_FLAGS_O3__RETRO}"
AB_FLAGS_O3__POWERPC="${AB_FLAGS_O3__RETRO}"
AB_FLAGS_O3__PPC64="${AB_FLAGS_O3__RETRO}"

USECLANG=0

NOLTO=1

ABSPLITDBG__RETRO=0
ABSPLITDBG__ARMV4="${ABSPLITDBG__RETRO}"
ABSPLITDBG__ARMV6HF="${ABSPLITDBG__RETRO}"
ABSPLITDBG__ARMV7HF="${ABSPLITDBG__RETRO}"
ABSPLITDBG__I486="${ABSPLITDBG__RETRO}"
ABSPLITDBG__LOONGSON2F="${ABSPLITDBG__RETRO}"
ABSPLITDBG__M68K="${ABSPLITDBG__RETRO}"
ABSPLITDBG__POWERPC="${ABSPLITDBG__RETRO}"
ABSPLITDBG__PPC64="${ABSPLITDBG__RETRO}"

# Figure out which feature/module to enable
_LLVM_MIN_SET="clang" # for Afterglow and other new ports
_LLVM_BASE_SET="${_LLVM_MIN_SET};lld" # for main-T2 arch (e.g. loongson3, riscv64 ...)
_LLVM_FULL_SET="${_LLVM_BASE_SET}" # for main-T1 arch (e.g. amd64, arm64 ...)

_LLVM_BASE_RUNTIME_SET=""
_LLVM_FULL_RUNTIME_SET=""
_LLVM_BASE_RUNTIME_SET__LOONGARCH64=""
# FIXME: Runtime libraries does not build without lld.
_LLVM_BASE_RUNTIME_SET__LOONGSON3=""
_LLVM_BASE_RUNTIME_SET__MIPS64R6EL=""

CMAKE_AFTER="-DLLVM_BUILD_LLVM_DYLIB=ON \
             -DLLVM_DYLIB_EXPORT_ALL=ON \
             -DLLVM_LINK_LLVM_DYLIB=ON \
             -DLLVM_ENABLE_RTTI=ON \
             -DLLVM_ENABLE_FFI=ON \
             -DLLVM_BUILD_DOCS=OFF \
             -DLLVM_ENABLE_PER_TARGET_RUNTIME_DIR=OFF \
             -DFFI_INCLUDE_DIR=$(pkg-config --variable=includedir libffi) \
             -DLLVM_BINUTILS_INCDIR=/usr/include \
             -DLLVM_INSTALL_UTILS=ON \
             -DLLVM_INCLUDE_TESTS=OFF \
             -DLLVM_USE_LINKER= \
             -DLIBCXXABI_USE_LLVM_UNWINDER=OFF"
# Mainline
CMAKE_AFTER__BASE=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_BASE_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_BASE_RUNTIME_SET}"
CMAKE_AFTER__FULL=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_FULL_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_FULL_RUNTIME_SET}"
CMAKE_AFTER__AMD64="${CMAKE_AFTER__FULL}"
CMAKE_AFTER__ARM64="${CMAKE_AFTER__FULL}"
CMAKE_AFTER__LOONGARCH64=" \
             ${CMAKE_AFTER__FULL} \
             -DLLVM_USE_LINKER=bfd \
             -DLLVM_PARALLEL_LINK_JOBS=2"
CMAKE_AFTER__LOONGSON3=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_BASE_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_BASE_RUNTIME_SET__LOONGSON3} \
             -DLLVM_PARALLEL_LINK_JOBS=2 \
             -DLLVM_USE_LINKER="
CMAKE_AFTER__MIPS64R6EL=" \
             ${CMAKE_AFTER} \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_BASE_SET} \
             -DLLVM_ENABLE_RUNTIMES=${_LLVM_BASE_RUNTIME_SET__MIPS64R6EL} \
             -DLLVM_USE_LINKER=bfd"
CMAKE_AFTER__RISCV64="${CMAKE_AFTER__BASE} -DLLVM_PARALLEL_LINK_JOBS=2"
CMAKE_AFTER__PPC64EL="${CMAKE_AFTER__BASE} -DLLVM_PARALLEL_LINK_JOBS=2"

# Retro
CMAKE_AFTER__RETRO=" \
             -DLLVM_BUILD_LLVM_DYLIB=ON \
             -DLLVM_DYLIB_EXPORT_ALL=ON \
             -DLLVM_LINK_LLVM_DYLIB=ON \
             -DLLVM_ENABLE_RTTI=ON \
             -DLLVM_ENABLE_FFI=ON \
             -DLLVM_BUILD_DOCS=OFF \
             -DLLVM_ENABLE_PROJECTS=${_LLVM_MIN_SET} \
             -DLLVM_ENABLE_PER_TARGET_RUNTIME_DIR=OFF \
             -DFFI_INCLUDE_DIR=$(pkg-config --variable=includedir libffi) \
             -DLLVM_BINUTILS_INCDIR=/usr/include \
             -DLLVM_INSTALL_UTILS=ON \
             -DLLVM_INCLUDE_TESTS=OFF \
             -DLLVM_USE_LINKER=bfd"
CMAKE_AFTER__ARMV4="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__ARMV6HF="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__ARMV7HF="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__I486="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__LOONGSON2F="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__M68K="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__POWERPC="${CMAKE_AFTER__RETRO}"
CMAKE_AFTER__PPC64="${CMAKE_AFTER__RETRO}"

PKGBREAK="""
bcc<=0.27.0
bpftrace<=0.18.0
castxml<=0.6.1
ccls<=0.20220729-2
clazy<=1.11-1
codelite<=15.0
cquery<=20180718-5
edi<=0.8.0-5
dub<=1.34.0
gnome-builder<=42.1-2
intel-graphics-compiler<=1.0.7423
ispc<=1.20.0+git20230725
kdevelop<=22.08.3-1
ldc<=1.34.0
liblphobos<=1.24.0-1
libobjc2<=2.1-1
llvm<=11.1.0
mesa<=1:23.2.1-1
opencl-clang<=16.0.0
openstf<=3.3.0
openvdb<=10.0.1-2
pocl<=1:1.6-1
postgresql<=13.11-1
pyside2<=5.15.11
qt-5<=1:5.15.1+wk5.212.0-5
qtcreator<=4.14.1-1
rustc<=1:1.71.1-1
spirv-llvm-translator<=16.0.0
"""

PKGREP="llvm<=3.7.0-2"
