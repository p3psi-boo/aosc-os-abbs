#!/usr/bin/env bash
###########################################################
# This script generates a memtest86plus entry on grub.cfg #
# if memtest is installed on the system.                  #
###########################################################

prefix="/usr"
exec_prefix="${prefix}"

datarootdir="/usr/share"
datadir="${datarootdir}"

. "${datadir}/grub/grub-mkconfig_lib"

MEMTEST86_IMAGE_AMD64_EFI="/boot/memtest86plus/memtest64.efi"
MEMTEST86_IMAGE_IA32_EFI="/boot/memtest86plus/memtest32.efi"
MEMTEST86_IMAGE_PC="/boot/memtest86plus/memtest32.bin"
CLASS="--class memtest86 --class gnu --class tool"

if [ -d /sys/firmware/efi ] && [ -e "${MEMTEST86_IMAGE_AMD64_EFI}" ] && is_path_readable_by_grub "${MEMTEST86_IMAGE_AMD64_EFI}" ; then
    ## image exists, create menu entry
    echo "Found memtest86plus image: ${MEMTEST86_IMAGE_AMD64_EFI}" >&2
    _GRUB_MEMTEST_HINTS_STRING="$(${grub_probe} --target=hints_string ${MEMTEST86_IMAGE_AMD64_EFI})"
    _GRUB_MEMTEST_FS_UUID="$(${grub_probe} --target=fs_uuid ${MEMTEST86_IMAGE_AMD64_EFI})"
    _GRUB_MEMTEST_REL_PATH="$(make_system_path_relative_to_its_root ${MEMTEST86_IMAGE_AMD64_EFI})"
    cat << EOF
if [ "\${grub_platform}" == "efi" -a "\${grub_cpu}" = "x86_64" ]; then
    menuentry "Memory Test" ${CLASS} {
        if loadfont unicode ; then
            set gfxmode=1024x768,800x600,auto
            set gfxpayload=800x600,1024x768
            terminal_output gfxterm
        fi
        search --fs-uuid --no-floppy --set=root ${_GRUB_MEMTEST_HINTS_STRING} ${_GRUB_MEMTEST_FS_UUID}
        linux ${_GRUB_MEMTEST_REL_PATH} ${GRUB_CMDLINE_MEMTEST86}
    }
fi
EOF
fi

if [ -d /sys/firmware/efi ] && [ -e "${MEMTEST86_IMAGE_IA32_EFI}" ] && is_path_readable_by_grub "${MEMTEST86_IMAGE_IA32_EFI}" ; then
    ## image exists, create menu entry
    echo "Found memtest86plus image: ${MEMTEST86_IMAGE_IA32_EFI}" >&2
    _GRUB_MEMTEST_HINTS_STRING="$(${grub_probe} --target=hints_string ${MEMTEST86_IMAGE_IA32_EFI})"
    _GRUB_MEMTEST_FS_UUID="$(${grub_probe} --target=fs_uuid ${MEMTEST86_IMAGE_IA32_EFI})"
    _GRUB_MEMTEST_REL_PATH="$(make_system_path_relative_to_its_root ${MEMTEST86_IMAGE_IA32_EFI})"
    cat << EOF
if [ "\${grub_platform}" == "efi" -a "\${grub_cpu}" = "i386" ]; then
    menuentry "Memory Test" ${CLASS} {
        if loadfont unicode ; then
            set gfxmode=1024x768,800x600,auto
            set gfxpayload=800x600,1024x768
            terminal_output gfxterm
        fi
        search --fs-uuid --no-floppy --set=root ${_GRUB_MEMTEST_HINTS_STRING} ${_GRUB_MEMTEST_FS_UUID}
        linux ${_GRUB_MEMTEST_REL_PATH} ${GRUB_CMDLINE_MEMTEST86}
    }
fi
EOF
fi

if [ ! -d /sys/firmware/efi ] && [ -e "${MEMTEST86_IMAGE_PC}" ] && is_path_readable_by_grub "${MEMTEST86_IMAGE_PC}" ; then
    ## image exists, create menu entry
    echo "Found memtest86plus image: ${MEMTEST86_IMAGE_PC}" >&2
    _GRUB_MEMTEST_HINTS_STRING="$(${grub_probe} --target=hints_string ${MEMTEST86_IMAGE_PC})"
    _GRUB_MEMTEST_FS_UUID="$(${grub_probe} --target=fs_uuid ${MEMTEST86_IMAGE_PC})"
    _GRUB_MEMTEST_REL_PATH="$(make_system_path_relative_to_its_root ${MEMTEST86_IMAGE_PC})"
    cat << EOF
if [ "\${grub_platform}" == "pc" ]; then
    menuentry "Memory Test" ${CLASS} {
        search --fs-uuid --no-floppy --set=root ${_GRUB_MEMTEST_HINTS_STRING} ${_GRUB_MEMTEST_FS_UUID}
        linux16 ${_GRUB_MEMTEST_REL_PATH} ${GRUB_CMDLINE_MEMTEST86}
    }
fi
EOF
fi
