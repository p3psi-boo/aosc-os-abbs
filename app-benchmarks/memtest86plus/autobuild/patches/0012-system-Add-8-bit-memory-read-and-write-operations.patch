From f692ffa1b891e09eef57f59d53d7299a2900e187 Mon Sep 17 00:00:00 2001
From: Chao Li <lichao@loongson.cn>
Date: Tue, 11 Jun 2024 20:19:45 +0800
Subject: [PATCH 12/43] system: Add 8-bit memory read and write operations

Added X64, I386 and LoongArch64 8-bit memory read and wirte operations.

Signed-off-by: Chao Li <lichao@loongson.cn>
---
 system/memrw8.h | 93 +++++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 93 insertions(+)
 create mode 100644 system/memrw8.h

diff --git a/system/memrw8.h b/system/memrw8.h
new file mode 100644
index 0000000..17dff94
--- /dev/null
+++ b/system/memrw8.h
@@ -0,0 +1,93 @@
+// SPDX-License-Identifier: GPL-2.0
+#ifndef MEMRW8_H
+#define MEMRW8_H
+/**
+ * \file
+ *
+ * Provides some 8-bit memory access functions. These stop the compiler
+ * optimizing accesses which need to be ordered and atomic. Mostly used
+ * for accessing memory-mapped hardware registers.
+ *
+ *//*
+ * Copyright (C) 2021-2022 Martin Whitaker.
+ */
+
+#include <stdint.h>
+
+/**
+ * Reads and returns the value stored in the 8-bit memory location pointed
+ * to by ptr.
+ */
+static inline uint8_t read8(const volatile uint8_t *ptr)
+{
+    uint8_t val;
+#if defined(__i386__) || defined(__x86_64__)
+    __asm__ __volatile__(
+        "movb %1, %0"
+        : "=r" (val)
+        : "m" (*ptr)
+        : "memory"
+    );
+#elif defined(__loongarch_lp64)
+    __asm__ __volatile__(
+        "ld.b %0, %1"
+        : "=r" (val)
+        : "m" (*ptr)
+        : "memory"
+    );
+#endif
+    return val;
+}
+
+/**
+ * Writes val to the 8-bit memory location pointed to by ptr.
+ */
+static inline void write8(const volatile uint8_t *ptr, uint8_t val)
+{
+#if defined(__i386__) || defined(__x86_64__)
+    __asm__ __volatile__(
+        "movb %1, %0"
+        :
+        : "m" (*ptr),
+          "r" (val)
+        : "memory"
+    );
+#elif defined(__loongarch_lp64)
+    __asm__ __volatile__(
+        "st.b %1, %0"
+        :
+        : "m" (*ptr),
+          "r" (val)
+        : "memory"
+    );
+#endif
+}
+
+/**
+ * Writes val to the 8-bit memory location pointed to by ptr. Reads it
+ * back (and discards it) to ensure the write is complete.
+ */
+static inline void flush8(const volatile uint8_t *ptr, uint8_t val)
+{
+#if defined(__i386__) || defined(__x86_64__)
+    __asm__ __volatile__(
+        "movb %1, %0\n"
+        "movb %0, %1"
+        :
+        : "m" (*ptr),
+          "r" (val)
+        : "memory"
+    );
+#elif defined(__loongarch_lp64)
+    __asm__ __volatile__(
+        "st.b %1, %0\n"
+        "ld.b %1, %0"
+        :
+        : "m" (*ptr),
+          "r" (val)
+        : "memory"
+    );
+#endif
+}
+
+#endif // MEMRW8_H
-- 
2.43.4

