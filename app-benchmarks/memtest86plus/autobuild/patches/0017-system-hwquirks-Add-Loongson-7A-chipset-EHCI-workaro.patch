From 941546219e543421af16de19514bb04a7f06fd8c Mon Sep 17 00:00:00 2001
From: Chao Li <lichao@loongson.cn>
Date: Wed, 12 Jun 2024 15:03:11 +0800
Subject: [PATCH 17/43] system/hwquirks: Add Loongson 7A chipset EHCI
 workaround

Added the 7A1000/7A2000 EHCI workaround.

Singed-off-by: Chao Li <lichao@loongson.cn>
---
 system/hwquirks.c | 29 +++++++++++++++++++++++++++++
 system/hwquirks.h |  3 ++-
 2 files changed, 31 insertions(+), 1 deletion(-)

diff --git a/system/hwquirks.c b/system/hwquirks.c
index f1fd0ed..d12ac55 100644
--- a/system/hwquirks.c
+++ b/system/hwquirks.c
@@ -16,6 +16,9 @@
 #include "cpuid.h"
 #include "config.h"
 #include "temperature.h"
+#include "memrw8.h"
+#include "memrw32.h"
+#include "vmem.h"
 
 quirk_t quirk;
 
@@ -99,6 +102,23 @@ static void amd_k8_revfg_temp(void)
     cpu_temp_offset = 21.0f;
 }
 
+static void loongson_7a00_ehci_workaround(void)
+{
+    uintptr_t reg_addr = 0x10010000;
+
+#ifdef CONFIG_64BIT
+    reg_addr |= 0xEULL << 40;
+#endif
+    reg_addr = map_region(reg_addr, 0x0, false);
+    write8((uint8_t *)(reg_addr + 0x3820), 0xFF);
+    write8((uint8_t *)(reg_addr + 0x3830), 0xFF);
+    write32 ((uint32_t *)(reg_addr + 0x3100), 0xFFFFFFFF);
+    write32 ((uint32_t *)(reg_addr + 0x3180), 0xFFFFFFFF);
+    write8((uint8_t *)(reg_addr + 0x3820), 0x0);
+    write8((uint8_t *)(reg_addr + 0x3830), 0x0);
+}
+
+
 // ---------------------
 // -- Public function --
 // ---------------------
@@ -199,4 +219,13 @@ void quirks_init(void)
             }
         }
     }
+
+    //  -----------------------------------------------------------
+    //  -- Loongson 7A1000 and 7A2000 chipset USB 2.0 workaround --
+    //  -----------------------------------------------------------
+    if (quirk.root_vid == PCI_VID_LOONGSON && quirk.root_did == 0x7a00) {
+        quirk.id    = QUIRK_LOONGSON7A00_EHCI_WORKARD;
+        quirk.type |= QUIRK_TYPE_USB;
+        quirk.process = loongson_7a00_ehci_workaround;
+    }
 }
diff --git a/system/hwquirks.h b/system/hwquirks.h
index daf22b8..bc3365d 100644
--- a/system/hwquirks.h
+++ b/system/hwquirks.h
@@ -28,7 +28,8 @@ typedef enum {
     QUIRK_X10SDV_NOSMP,
     QUIRK_K8_BSTEP_NOTEMP,
     QUIRK_K8_REVFG_TEMP,
-    QUIRK_AMD_ERRATA_319
+    QUIRK_AMD_ERRATA_319,
+    QUIRK_LOONGSON7A00_EHCI_WORKARD
 } quirk_id_t;
 
 typedef struct {
-- 
2.43.4

