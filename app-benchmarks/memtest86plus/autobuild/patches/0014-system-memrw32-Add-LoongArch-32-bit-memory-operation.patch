From fb7951bc5f74312c4e38b31dff43c4beee1a94ac Mon Sep 17 00:00:00 2001
From: Chao Li <lichao@loongson.cn>
Date: Tue, 11 Jun 2024 20:29:55 +0800
Subject: [PATCH 14/43] system/memrw32: Add LoongArch 32-bit memory operations

Added 32-bit memory read and write operations for LoongArch64.

Signed-off-by: Chao Li <lichao@loongson.cn>
---
 system/memrw32.h | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/system/memrw32.h b/system/memrw32.h
index e9316ec..878b910 100644
--- a/system/memrw32.h
+++ b/system/memrw32.h
@@ -21,12 +21,21 @@
 static inline uint32_t read32(const volatile uint32_t *ptr)
 {
     uint32_t val;
+#if defined(__i386__) || defined(__x86_64__)
     __asm__ __volatile__(
         "movl %1, %0"
         : "=r" (val)
         : "m" (*ptr)
         : "memory"
     );
+#elif defined(__loongarch_lp64)
+    __asm__ __volatile__(
+        "ld.w %0, %1"
+        : "=r" (val)
+        : "m" (*ptr)
+        : "memory"
+    );
+#endif
     return val;
 }
 
@@ -35,6 +44,7 @@ static inline uint32_t read32(const volatile uint32_t *ptr)
  */
 static inline void write32(const volatile uint32_t *ptr, uint32_t val)
 {
+#if defined(__i386__) || defined(__x86_64__)
     __asm__ __volatile__(
         "movl %1, %0"
         :
@@ -42,6 +52,15 @@ static inline void write32(const volatile uint32_t *ptr, uint32_t val)
           "r" (val)
         : "memory"
     );
+#elif defined(__loongarch_lp64)
+    __asm__ __volatile__(
+        "st.w %1, %0"
+        :
+        : "m" (*ptr),
+          "r" (val)
+        : "memory"
+    );
+#endif
 }
 
 /**
@@ -50,6 +69,7 @@ static inline void write32(const volatile uint32_t *ptr, uint32_t val)
  */
 static inline void flush32(const volatile uint32_t *ptr, uint32_t val)
 {
+#if defined(__i386__) || defined(__x86_64__)
     __asm__ __volatile__(
         "movl %1, %0\n"
         "movl %0, %1"
@@ -58,6 +78,16 @@ static inline void flush32(const volatile uint32_t *ptr, uint32_t val)
           "r" (val)
         : "memory"
     );
+#elif defined(__loongarch_lp64)
+    __asm__ __volatile__(
+        "st.w %1, %0\n"
+        "ld.w %1, %0"
+        :
+        : "m" (*ptr),
+          "r" (val)
+        : "memory"
+    );
+#endif
 }
 
 #endif // MEMRW32_H
-- 
2.43.4

